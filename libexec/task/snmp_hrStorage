#!/bin/sh
#
# Check for free space in a volume, swap or memory.
#
# Usage: snmp_hrStorage <VOL> <THRESHOLD_BYTES>
#
# You can get a list of available volumes with the command:
#
#   snmp walk -c <SNMP_COMMUNITY> -v <SNMP_VERSION> <SNMP_HOST> hrStorageDescr
#

set -e
[ -n "${SNMP_HOST}" ] \
  || ( echo "SNMP_HOST is undefined" >&2 && exit 1 )

[ $# -ne 2 ] \
  && ( echo "command did not receive two arguments" >&2 && exit 1 )

set -u

VOL=$1
THRESHOLD=$2

if [ $(uname -s) = "OpenBSD" ]; then
  SNMP_WALK="snmp walk"
  SNMP_GET="snmp get"
else
  SNMP_WALK="snmpwalk"
  SNMP_GET="snmpget"
fi

SNMP_VERSION=${SNMP_VERSION:-2c}
SNMP_COMMUNITY=${SNMP_COMMUNITY:-public}

storageInt() {
  ${SNMP_WALK} -v "${SNMP_VERSION}" -c "${SNMP_COMMUNITY}" "${SNMP_HOST}" hrStorageDescr \
    | awk -F= -v vol=" STRING: $1" '($2==vol) { sub(".*hrStorageDescr\.","",$1); print int($1) }'
}

storageAllocationUnits() {
  ${SNMP_GET} -v "${SNMP_VERSION}" -c "${SNMP_COMMUNITY}" "${SNMP_HOST}" "hrStorageAllocationUnits.$1" \
    | awk '{ print $NF }'
}

storageSizeBytes() {
  ${SNMP_GET} -v "${SNMP_VERSION}" -c "${SNMP_COMMUNITY}" "${SNMP_HOST}" "hrStorageSize.$1" \
    | awk -F= -v n=1 '{ sub(".*: ","",$NF); sub("\ Bytes$","",$NF); print $NF }'
}

storageUsedBytes() {
  ${SNMP_GET} -v "${SNMP_VERSION}" -c "${SNMP_COMMUNITY}" "${SNMP_HOST}" "hrStorageUsed.$1" \
    | awk -v n="$2" '{ print $NF * n }'
}

storageFreeBytes() {
  size=$(storageSizeBytes "$i" "$n")
  used=$(storageUsedBytes "$i" "$n")
  echo $((size - used))
}

i=$(storageInt "${VOL}")
n=$(storageAllocationUnits "$i")
f=$(storageFreeBytes "$1" "$n")
echo $f

[ $f -gt ${THRESHOLD} ]
