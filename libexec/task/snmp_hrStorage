#!/bin/sh
if [ $# -lt 3 ]; then
  echo "usage: $0 <host> <path>" >&2
  exit 1
fi

SNMP_HOST=$1
SNMP_VERSION=${SNMP_VERSION:-2c}
SNMP_COMMUNITY=${SNMP_COMMUNITY:-public}

storageInt() {
  snmp walk -v "${SNMP_VERSION}" -c "${SNMP_COMMUNITY}" "${SNMP_HOST}" hrStorageDescr \
    | awk '($NF=="/") { sub("hrStorageDescr\.","",$1); print $1 }'
}

storageAllocationUnits() {
  snmp get -v "${SNMP_VERSION}" -c "${SNMP_COMMUNITY}" "${SNMP_HOST}" "hrStorageAllocationUnits.$1" \
    | awk '{ print $NF }'
}

storageSize() {
  snmp get -v "${SNMP_VERSION}" -c "${SNMP_COMMUNITY}" "${SNMP_HOST}" "hrStorageSize.$1" \
    | awk -v n="$2" '{ print $NF * n }'
}

storageUsed() {
  snmp get -v "${SNMP_VERSION}" -c "${SNMP_COMMUNITY}" "${SNMP_HOST}" "hrStorageUsed.$1" \
    | awk -v n="$2" '{ print $NF * n }'
}

i=$(storageInt "$2")
n=$(storageAllocationUnits "$i")

storageSize "$i" "$n"
storageUsed "$i" "$n"
